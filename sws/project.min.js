var domain, locId, date, nd, nw, viewport, interval, startThisWeek, startNextWeek, lang, isAndroidBrowser, pdfdownloadLink;
$(document).ready(function() {
    var a = navigator.userAgent;
    var f = a.indexOf("Android") > -1 && a.indexOf("Mozilla/5.0") > -1 && a.indexOf("AppleWebKit") > -1;
    var c = new RegExp(/AppleWebKit\/([\d.]+)/);
    var e = c.exec(a);
    var b = (e === null ? null : parseFloat(c.exec(a)[1]));
    var h = new RegExp(/Chrome\/([\d.]+)/);
    var d = h.exec(a);
    var g = (d === null ? null : parseFloat(h.exec(a)[1]));
    isAndroidBrowser = f && (b !== null && b < 537) || (g !== null && g < 37);
    domain = $("#hiddenDomain").val();
    Cookies.set("domain", domain, {
        sameSite: "none",
        secure: true
    });
    locId = $("#hiddenLocId").val();
	
	function formatDate(date) {
		month = date.getMonth() + 1,
		day = date.getDate(),
		year = date.getFullYear();
		if(month < 10) month = '0'+month;
		if(day < 10) day = '0'+day;
		return year+'-'+month+'-'+day;
	}
	
	var today = new Date();
	today.setHours(0,0,0,0);
	var startFirstWeek = new Date(today.getTime());
	if(today.getDay() > 0 && today.getDay() < 6) {
		startFirstWeek.setDate(today.getDate() - today.getDay() + 1);
		date = formatDate(today);
	} else if(today.getDay() == 0) {
		startFirstWeek.setDate(today.getDate() + 1);
		date = formatDate(startFirstWeek);
	} else if(today.getDay() == 6) {
		startFirstWeek.setDate(today.getDate() + 2);
		date = formatDate(startFirstWeek);
	}
	
	var startSecondWeek = new Date(startFirstWeek.getTime());
	startSecondWeek.setDate(startSecondWeek.getDate() + 7);
    startThisWeek = formatDate(startFirstWeek);
    startNextWeek = formatDate(startSecondWeek);
	
    $("#listbox-locations").val(locId);
    viewport = findBootstrapEnvironment();
    if (viewport == "xs" || viewport == "sm") {
        $("#toggleFilterPanel").removeClass("text-right")
    }
    if (undefined === Cookies.get("savekennzfilterinput")) {
        Cookies.set("savekennzfilterinput", 1, {
            expires: 100,
            domain: Cookies.get("domain"),
            sameSite: "none",
            secure: true
        })
    }
    if ($("#savekennzfilterinput").length == 1) {
        $("#savekennzfilterinput").on("click", function() {
            if (true === $(this).prop("checked")) {
                Cookies.set("savekennzfilterinput", 1, {
                    expires: 100,
                    domain: Cookies.get("domain"),
                    sameSite: "none",
                    secure: true
                })
            } else {
                Cookies.set("savekennzfilterinput", 0, {
                    expires: 100,
                    domain: Cookies.get("domain"),
                    sameSite: "none",
                    secure: true
                })
            }
        })
    }
    if (Cookies.get("savekennzfilterinput") == 1) {
        $("#savekennzfilterinput").prop("checked", true)
    }
    lang = $("#hiddenLang").val();
    $("#" + date).addClass("active");
    $("#dw").on("click", function() {
        nw = false;
        loadSpeiseplanWochentag(locId, startThisWeek, 1, lang, startThisWeek, startNextWeek);
        $(this).toggleClass("hidden");
        $("#nw").toggleClass("hidden")
    });
    $("#nw").on("click", function() {
        nw = true;
        loadSpeiseplanWochentag(locId, startNextWeek, 1, lang, startThisWeek, startNextWeek);
        $(this).toggleClass("hidden");
        $("#dw").toggleClass("hidden")
    });
    $("#dw").on("keypress", function(i) {
        if (i.which == 13) {
            nw = false;
            loadSpeiseplanWochentag(locId, startThisWeek, 1, lang, startThisWeek, startNextWeek);
            $(this).toggleClass("hidden");
            $("#nw").toggleClass("hidden")
        }
    });
    $("#nw").on("keypress", function(i) {
        if (i.which == 13) {
            nw = true;
            loadSpeiseplanWochentag(locId, startNextWeek, 1, lang, startThisWeek, startNextWeek);
            $(this).toggleClass("hidden");
            $("#dw").toggleClass("hidden")
        }
    });
    loadSpeiseplanWochentag(locId, date, 1, lang, startThisWeek, startNextWeek);
    $("#listbox-locations").change(function() {
        locId = $("#listbox-locations").val();
        $(".panel_item").each(function() {
            if ($(this).hasClass("active")) {
                date = $(this).attr("id")
            }
        });
        loadSpeiseplanWochentag(locId, date, 0, lang, startThisWeek, startNextWeek)
    });
    $(".panel_item").each(function() {
        $(this).click(function(i) {
            panelItemAction(i, $(this), lang, startThisWeek, startNextWeek)
        });
        $(this).on("keypress", function(i) {
            if (i.which == 13) {
                panelItemAction(i, $(this), lang, startThisWeek, startNextWeek)
            }
        })
    });
    $("#toggleFilterPanel").click(function() {
        var i = $(this).find("img");
        if ($(".kennzfilter").hasClass("hide")) {
            i.attr("src", "https://sws2.maxmanager.xyz/assets/icons/up.png")
        } else {
            i.attr("src", "https://sws2.maxmanager.xyz/assets/icons/down.png")
        }
        $(".kennzfilter").toggleClass("hide")
    });
    $("#clearAll").click(function() {
        clearSplFilter()
    });
    $("#toggleLegende").on("click", function() {
        legendeEvent($(this))
    });
    $("#toggleLegende").on("keypress", function(i) {
        if (i.which == 13) {
            legendeEvent($(this))
        }
    });
    adaptHeightWoWe();
    $("#listbox-locations").focus()
});
var calcDate = function(b, a, c) {
    nd = new Date(new Date(b));
    nd.setDate(nd.getDate() + (a - nd.getDay()));
    if (c == 2) {
        return ("0" + nd.getDate()).slice(-2) + "." + ("0" + (nd.getMonth() + 1)).slice(-2)
    }
    return nd.getFullYear() + "-" + ("0" + (nd.getMonth() + 1)).slice(-2) + "-" + ("0" + nd.getDate()).slice(-2)
};
var setDateTabs = function(c) {
    var a, b, e, d;
    interval = 1;
    $(".panel_item").each(function() {
        a = $(this).attr("id");
        b = $(this).find(".panelItemInner");
        e = b.html();
        b.html(e.substr(0, 3) + calcDate(c, interval, 2) + ".");
        d = calcDate(c, interval);
        $(this).attr("id", d);
        $("#" + d).removeClass("active");
        if (d == c) {
            $("#" + d).addClass("active")
        }
        interval++
    })
};
var panelItemAction = function(d, b, f, c, a) {
    $(".panel_item").each(function() {
        $(this).removeClass("active")
    });
    d.preventDefault();
    locId = $("#listbox-locations").val();
    date = b.attr("id");
    $("#" + date).addClass("active");
    loadSpeiseplanWochentag(locId, date, 0, f, c, a)
};
$(window).resize(function() {
    clearTimeout(window.resizedFinished);
    window.resizedFinished = setTimeout(function() {
        fotos();
        adaptHeightWoWe()
    }, 150);
    viewport = findBootstrapEnvironment();
    if (viewport == "xs" || viewport == "sm") {
        $("#toggleFilterPanel").removeClass("text-right")
    } else {
        $("#toggleFilterPanel").addClass("text-right")
    }
});
$(window).scroll(function() {
    clearTimeout(window.scrollFinished);
    window.scrollFinished = setTimeout(function() {
        fotos()
    }, 150)
});
var loadSpeiseplanWochentag = function(d, b, f, e, c, a) {
    $.ajax({
        type: "POST",
        url: "/server/sws.php",
        data: {
            func: "make_spl",
            locId: d,
            date: b,
            lang: e,
            startThisWeek: c,
            startNextWeek: a
        },
        datatype: "html",
        beforeSend: function() {
            //$("#loader").toggleClass("hidden")
        },
        complete: function() {
            //$("#loader").toggleClass("hidden")
        },
        success: function(h, i, g) {
            $("#speiseplan").html(h);
            if (f == 1) {
                setDateTabs(b)
            }
            azn();
            if (undefined !== Cookies.get("filterkennz")) {
                setFilterFromCookie()
            }
            filterArtikel();
            fotos();
            Cookies.set("locId", d, {
                expires: 100,
                domain: Cookies.get("domain"),
                sameSite: "none",
                secure: true
            });
            if (true === isAndroidBrowser) {
                $(".downloadpdf").each(function() {
                    pdfdownloadLink = $(this).attr("href");
                    $(this).attr("href", "https://docs.google.com/viewerng/viewer?url=" + pdfdownloadLink)
                })
            }
			adaptHeightWoWe();
        },
        error: function(g, i, h) {
            $("#speiseplan").html(i)
        }
    })
};
var azn = function() {
    var a;
    $(".show-azn").each(function() {
        $(this).on("click", function() {
            aznEvent($(this))
        });
        $(this).on("keypress", function(b) {
            if (b.which == 13) {
                aznEvent($(this))
            }
        })
    })
};
var aznEvent = function(a) {
    a.next(".azn").toggleClass("hidden");
    if (!a.next(".azn").hasClass("hidden")) {
        a.html("- ALLERGENE | ZUSATZSTOFFE | CO2 | NÄHRWERTE")
    } else {
        a.html("+ ALLERGENE | ZUSATZSTOFFE | CO2 | NÄHRWERTE")
    }
};
var legendeEvent = function(b) {
    var a = "LEGENDE";
    if ($("#hiddenLang").val() == "en") {
        a = "LEGEND"
    }
    var d = b.position();
    var c = $("div.legende");
    c.toggleClass("hidden");
    if (!c.hasClass("hidden")) {
        b.html("- " + a);
        window.scrollTo(0, (d.top - 350))
    } else {
        b.html("+ " + a)
    }
};
var filterArtikel = function() {
    if (Cookies.get("savekennzfilterinput") != 1) {
        filterArtikelOhneCookie();
        return
    }
    var c = {
        expires: 100,
        domain: Cookies.get("domain"),
        sameSite: "none",
        secure: true
    };
    var g, e, f, d, a, b;
    if (undefined == Cookies.get("filterkennz")) {
        e = [];
        Cookies.set("filterkennz", JSON.stringify(e), c)
    }
    e = JSON.parse(Cookies.get("filterkennz"));
    $("input.itemkennz").each(function() {
        g = sanitizeId($(this).attr("id"), "stoff-");
        if (true === $(this).prop("checked") && (-1 == $.inArray(g, e))) {
            e.push(g)
        } else {
            if (false === $(this).prop("checked") && (-1 !== $.inArray(g, e))) {
                e.splice($.inArray(g, e), 1)
            }
        }
    });
    Cookies.set("filterkennz", JSON.stringify(e), c);
    if (undefined !== Cookies.get("filterkennz")) {
        if (JSON.parse(Cookies.get("filterkennz")).length > 0) {
            $("div.splMeal").each(function() {
                f = false;
                d = $(this);
                $(this).removeClass("filtered");
                a = d.attr("lang");
                b = a.split(",");
                $.each(b, function(h, i) {
                    if (-1 !== $.inArray(i, JSON.parse(Cookies.get("filterkennz")))) {
                        f = true;
                        return
                    }
                });
                if (true === f) {
                    d.addClass("filtered")
                }
            })
        } else {
            $("div.splMeal").each(function() {
                $(this).removeClass("filtered")
            })
        }
    }
    styleFilterItems()
};
var filterArtikelOhneCookie = function() {
    var f, d, e, c, a, b;
    d = [];
    $("input.itemkennz").each(function() {
        f = sanitizeId($(this).attr("id"), "stoff-");
        if (true === $(this).prop("checked") && (-1 == $.inArray(f, d))) {
            d.push(f)
        } else {
            if (false === $(this).prop("checked") && (-1 !== $.inArray(f, d))) {
                d.splice($.inArray(f, d), 1)
            }
        }
    });
    if (d.length > 0) {
        $("div.splMeal").each(function() {
            e = false;
            c = $(this);
            $(this).removeClass("filtered");
            a = c.attr("lang");
            b = a.split(",");
            $.each(b, function(g, h) {
                if (-1 !== $.inArray(h, d)) {
                    e = true;
                    return
                }
            });
            if (true === e) {
                c.addClass("filtered")
            }
        })
    } else {
        $("div.splMeal").each(function() {
            $(this).removeClass("filtered")
        })
    }
    styleFilterItems()
};
var sanitizeId = function(b, a) {
    return b.replace(a, "")
};
var setFilterFromCookie = function() {
    var a = JSON.parse(Cookies.get("filterkennz"));
    var b;
    $("input.itemkennz").each(function() {
        b = sanitizeId($(this).attr("id"), "stoff-");
        if (-1 !== $.inArray(b, a)) {
            $(this).attr("checked", "checked")
        }
    })
};
var clearSplFilter = function() {
    $("input.itemkennz").each(function() {
        $(this).prop("checked", false)
    });
    filterArtikel()
};
var styleFilterItems = function() {
    var b, a;
    $(".k-item-name").each(function() {
        b = $(this).attr("id");
        a = "stoff-" + b.replace(/kname-/g, "");
        if (true === $("#" + a).prop("checked")) {
            $("#" + b).addClass("kname-checked")
        } else {
            $("#" + b).removeClass("kname-checked")
        }
    })
};
var fotos = function() {
    if (viewport == "xs") {
        $(".smallFoto").off();
        $(".smallFoto").each(function() {
            $(this).removeClass("ptr")
        });
        $(".splMeal").each(function() {
            $(this).attr("style", "padding:10px 0 0 0");
            var c = $(this).find("img");
            var a = $(this).find(".preise-xs");
            var b = $(c).height() - $(a).height();
            $(a).css("padding-top", (b - 10) + "px")
        });
        return
    } else {
        $(".smallFoto").each(function() {
            if (!$(this).hasClass("ptr")) {
                $(this).addClass("ptr")
            }
        })
    }
    $(".smallFoto").off();
    $(".smallFoto").each(function() {
        $(this).hover(function() {
            toggleFotoPreview($(this))
        });
        $(this).on("touch", function() {
            toggleFotoPreview($(this))
        })
    })
};
var toggleFotoPreview = function(c) {
    var d = {
        sm: 400,
        md: 560,
        lg: 720
    };
    var n = d[viewport];
    var g = $(window).width();
    var a = $(window).height();
    var i = 80;
    var k, l, j, f, e, h, m, b;
    k = c.position();
    l = k.top;
    j = c.offset().top - $(window).scrollTop();
    f = c.outerWidth();
    e = c.outerHeight();
    b = e / f;
    h = g - i - f;
    if (h > n) {
        h = n
    }
    m = h * b;
    if (true === (j + m) > a) {
        l -= (j + m + 10) - a
    }
    c.next("img").css({
        top: l + "px",
        left: (k.left + f + 10) + "px",
        width: h + "px",
        height: m + "px"
    }).toggleClass("hidden")
};
var findBootstrapEnvironment = function() {
    var d = ["xs", "sm", "md", "lg"];
    var c = $("<div>");
    c.appendTo($("body"));
    for (var b = d.length - 1; b >= 0; b--) {
        var a = d[b];
        c.addClass("hidden-" + a);
        if (c.is(":hidden")) {
            c.remove();
            return a
        }
    }
};
var adaptHeightWoWe = function() {
    var a = $(".wowe").prev().height();
    $(".wowe").css({
        height: a + "px",
        "line-height": a + "px",
        "vertical-align": "middle"
    })
};